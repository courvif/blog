import time
import base64
import re
from DrissionPage import Chromium
from PIL import Image
from io import BytesIO
import easyocr
import numpy as np

browser = Chromium(9624)
tab = browser.latest_tab

# åˆå§‹åŒ–OCRè¯†åˆ«å™¨ï¼ˆåªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡ï¼‰
reader = easyocr.Reader(['en'])

# â­ æ¯ä¸ªMokiçš„Quickè®¡æ•°å™¨ï¼ˆå¯ä»¥è®¾ç½®åˆå§‹å€¼ï¼‰
MOKI_QUICK_COUNT = {
    '2905': 0,  # å¦‚æœä¹‹å‰è®­ç»ƒè¿‡ï¼Œå¯ä»¥æ”¹æˆ 1 æˆ– 2
    '5627': 0,  # å¦‚æœä¹‹å‰è®­ç»ƒè¿‡ï¼Œå¯ä»¥æ”¹æˆ 1 æˆ– 2
    '4832': 0,  # å¦‚æœä¹‹å‰è®­ç»ƒè¿‡ï¼Œå¯ä»¥æ”¹æˆ 1 æˆ– 2
}

# â­ Mokiç¼–å·ä¸è®­ç»ƒå±æ€§çš„æ˜ å°„
MOKI_TRAINING_MAP = {
    '2905': 'Dexterity',
    '5627': 'Speed',
    '4832': 'Speed',
}

def extract_canvas_image(canvas_elem):
    """ä»canvaså…ƒç´ æå–å›¾ç‰‡"""
    try:
        img_base64 = tab.run_js('''
            var canvas = arguments[0];
            return canvas.toDataURL('image/png');
        ''', canvas_elem)
        
        img_data = re.sub('^data:image/.+;base64,', '', img_base64)
        img_bytes = base64.b64decode(img_data)
        img = Image.open(BytesIO(img_bytes))
        return img

    except Exception as e:
        print(f"æå–Canvaså›¾ç‰‡å¤±è´¥: {e}")
        return None


def recognize_text_from_image(img):
    """ä½¿ç”¨OCRè¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—"""
    try:
        img_array = np.array(img)
        result = reader.readtext(img_array, detail=0)
        text = ' '.join(result)
        return text
    except Exception as e:
        print(f"OCRè¯†åˆ«å¤±è´¥: {e}")
        return ""


def get_moki_number():
    """è·å–å½“å‰é¡µé¢çš„Mokiç¼–å·"""
    try:
        # æ–¹æ³•1: ä½¿ç”¨XPathç²¾ç¡®å®šä½
        moki_elem = tab.ele('xpath=/html/body/div[3]/div[2]/main/div/div[2]/div[1]/div[1]/div[1]/div[2]/div[1]/p', timeout=3)
        
        if moki_elem:
            full_text = moki_elem.text  # ä¾‹å¦‚: "Moki #2905"
            print(f"  ğŸ“ è·å–åˆ°æ–‡æœ¬: {full_text}")
            
            # æå–æ•°å­—éƒ¨åˆ†
            match = re.search(r'#?(\d+)', full_text)
            if match:
                moki_number = match.group(1)
                print(f"  ğŸ”¢ Mokiç¼–å·: {moki_number}")
                return moki_number
        
        # æ–¹æ³•2: å¤‡é€‰æ–¹æ¡ˆ - é€šè¿‡classæŸ¥æ‰¾
        moki_elem = tab.ele('css:p.text-neutral-900.font-grandarena.text-2xl.uppercase', timeout=2)
        if moki_elem:
            full_text = moki_elem.text
            match = re.search(r'#?(\d+)', full_text)
            if match:
                moki_number = match.group(1)
                print(f"  ğŸ”¢ Mokiç¼–å· (å¤‡é€‰): {moki_number}")
                return moki_number
        
        print("  âš ï¸ æœªæ‰¾åˆ°Mokiç¼–å·")
        return None
        
    except Exception as e:
        print(f"  âŒ è·å–Mokiç¼–å·å¤±è´¥: {e}")
        return None


def click_element_by_text(text, timeout=3, description=""):
    """é€šç”¨çš„æ–‡æœ¬ç‚¹å‡»å‡½æ•°"""
    try:
        elem = tab.ele(f'text={text}', timeout=timeout)
        if elem:
            elem.click()
            print(f"  âœ… å·²ç‚¹å‡» {description or text}")
            return True
        
        # å°è¯•åŒ…å«æ–‡æœ¬åŒ¹é…
        elem = tab.ele(f'text:{text}', timeout=1)
        if elem:
            elem.click()
            print(f"  âœ… å·²ç‚¹å‡» {description or text}")
            return True
            
        print(f"  âš ï¸ æœªæ‰¾åˆ° {description or text}")
        return False
        
    except Exception as e:
        print(f"  âŒ ç‚¹å‡» {description or text} å¤±è´¥: {e}")
        return False


def select_training_attribute(moki_number):
    """æ ¹æ®Mokiç¼–å·é€‰æ‹©å¯¹åº”çš„è®­ç»ƒå±æ€§"""
    
    # æŸ¥æ‰¾æ˜ å°„
    if moki_number in MOKI_TRAINING_MAP:
        target_attribute = MOKI_TRAINING_MAP[moki_number]
        print(f"  ğŸ¯ Moki #{moki_number} éœ€è¦è®­ç»ƒ: {target_attribute}")
        
        if click_element_by_text(target_attribute, timeout=2, description=f"å±æ€§ {target_attribute}"):
            time.sleep(1)
            return True
        else:
            print(f"  âš ï¸ æ— æ³•ç‚¹å‡»å±æ€§ {target_attribute}")
            return False
    else:
        print(f"  âš ï¸ Moki #{moki_number} æ²¡æœ‰é…ç½®è®­ç»ƒå±æ€§ï¼Œè·³è¿‡")
        return False


def select_training_duration(moki_number):
    """é€‰æ‹©è®­ç»ƒæ—¶é•¿ï¼šæ¯ä¸ªMokiå•ç‹¬è®¡æ•°ï¼Œä¸¤æ¬¡Quickåå¿…é¡»é€‰ä¸€æ¬¡Steady"""
    
    # ç¡®ä¿è¿™ä¸ªMokiåœ¨è®¡æ•°å™¨ä¸­
    if moki_number not in MOKI_QUICK_COUNT:
        MOKI_QUICK_COUNT[moki_number] = 0
    
    try:
        current_count = MOKI_QUICK_COUNT[moki_number]
        
        if current_count < 2:
            # å°è¯•é€‰æ‹© Quick
            if click_element_by_text('Quick', timeout=2, description="è®­ç»ƒæ—¶é•¿ Quick"):
                MOKI_QUICK_COUNT[moki_number] += 1
                print(f"  ğŸ“Š Moki #{moki_number} Quickè®¡æ•°: {MOKI_QUICK_COUNT[moki_number]}/2")
                time.sleep(1)
                return True
        
        # å·²ç»é€‰äº†2æ¬¡Quickï¼Œå¿…é¡»é€‰Steady
        if click_element_by_text('Steady', timeout=2, description="è®­ç»ƒæ—¶é•¿ Steady"):
            MOKI_QUICK_COUNT[moki_number] = 0  # é‡ç½®è¿™ä¸ªMokiçš„è®¡æ•°å™¨
            print(f"  ğŸ“Š Moki #{moki_number} å·²é€‰Steadyï¼ŒQuickè®¡æ•°é‡ç½®ä¸º0")
            time.sleep(1)
            return True
            
        print("  âš ï¸ æœªæ‰¾åˆ°è®­ç»ƒæ—¶é•¿é€‰é¡¹")
        return False
        
    except Exception as e:
        print(f"  âŒ é€‰æ‹©è®­ç»ƒæ—¶é•¿å¤±è´¥: {e}")
        return False


def complete_training_flow(moki_number, is_from_train=False):
    """å®Œæˆä¸€æ¬¡å®Œæ•´çš„è®­ç»ƒæµç¨‹
    
    Args:
        moki_number: Mokiç¼–å·
        is_from_train: æ˜¯å¦ä»TrainæŒ‰é’®è¿›å…¥ï¼ˆTrueåˆ™è·³è¿‡Train Againæ­¥éª¤ï¼‰
    """
    try:
        print("\nğŸ”„ å¼€å§‹è®­ç»ƒæµç¨‹...")
        
        # 1. â­ åªæœ‰ä»Resultsè¿›å…¥æ‰éœ€è¦ç‚¹å‡» Train Again
        if not is_from_train:
            if not click_element_by_text('Train Again', timeout=3, description="Train Again"):
                return False
            time.sleep(1.5)
        else:
            print("  â­ï¸ ä»Trainè¿›å…¥ï¼Œè·³è¿‡Train Againæ­¥éª¤")
        
        # 2. æ ¹æ®ç¼–å·é€‰æ‹©è®­ç»ƒå±æ€§
        if not select_training_attribute(moki_number):
            return False
        
        # 3. ç‚¹å‡» Next
        if not click_element_by_text('Next', timeout=2, description="Next (å±æ€§ç¡®è®¤)"):
            return False
        time.sleep(1)
        
        # 4. æ ¹æ®Mokiç¼–å·é€‰æ‹©è®­ç»ƒæ—¶é•¿
        if not select_training_duration(moki_number):
            return False
        
        # 5. ç‚¹å‡» Next
        if not click_element_by_text('Next', timeout=2, description="Next (æ—¶é•¿ç¡®è®¤)"):
            return False
        time.sleep(1)
        
        # 6. ç‚¹å‡» Light
        if not click_element_by_text('Light', timeout=2, description="Light"):
            return False
        time.sleep(1)
        
        # 7. ç‚¹å‡» Next
        if not click_element_by_text('Next', timeout=2, description="Next (Lightç¡®è®¤)"):
            return False
        time.sleep(1)
        
        # 8. ç‚¹å‡» Next (å†æ¬¡ç¡®è®¤)
        if not click_element_by_text('Next', timeout=2, description="Next (æœ€ç»ˆç¡®è®¤)"):
            return False
        time.sleep(1)
        
        # 9. ç‚¹å‡» START
        if not click_element_by_text('START', timeout=2, description="START"):
            return False
        time.sleep(5)
        
        # 10. ç‚¹å‡» Back to All Mokis (ç­‰å¾…æ—¶é—´è¾ƒé•¿)
        print("  â³ ç­‰å¾…è¿”å›é¡µé¢åŠ è½½...")
        if not click_element_by_text('Back to All Mokis', timeout=25, description="Back to All Mokis"):
            return False
        time.sleep(20)  # ç­‰å¾…åˆ—è¡¨åˆ·æ–°
        
        print(f"âœ… Moki #{moki_number} è®­ç»ƒæµç¨‹å®Œæˆï¼")
        return True
        
    except Exception as e:
        print(f"âŒ è®­ç»ƒæµç¨‹å‡ºé”™: {e}")
        return False


def process_single_card(i, card):
    """å¤„ç†å•ä¸ªå¡ç‰‡"""
    try:
        title = card.ele('p.overflow-hidden', timeout=0.5)
        type_elem = card.ele('p.uppercase', timeout=0.5)
        canvas = card.ele('tag:canvas', timeout=0.5)

        print(f"\nå¡ç‰‡ {i+1}:")
        print(f"  æ ‡é¢˜: {title.text if title else 'æ— '}")
        print(f"  ç±»å‹: {type_elem.text if type_elem else 'æ— '}")

        if not canvas:
            print("  æ—  Canvas")
            return False

        img = extract_canvas_image(canvas)
        if not img:
            return False
        
        # OCRè¯†åˆ«æ–‡å­—
        recognized_text = recognize_text_from_image(img)
        print(f"  è¯†åˆ«åˆ°çš„æ–‡å­—: [{recognized_text}]")
        
        # æ£€æµ‹ COMPLETE æˆ– Resting
        if 'complete' in recognized_text.lower() or 'resting' in recognized_text.lower():
            print("  âœ… æ£€æµ‹åˆ° COMPLETE æˆ– Restingï¼Œå‡†å¤‡ç‚¹å‡»...")
            canvas.click()
            time.sleep(2)
            print("  å·²ç‚¹å‡» Canvas")
            
            # è·å–Mokiç¼–å·
            moki_number = get_moki_number()
            if not moki_number:
                print("  âŒ æ— æ³•è·å–Mokiç¼–å·ï¼Œè·³è¿‡è®­ç»ƒ")
                click_element_by_text('Back to All Mokis', timeout=5, description="è¿”å›åˆ—è¡¨")
                time.sleep(3)
                return False
            
            # æ£€æŸ¥æ˜¯å¦åœ¨è®­ç»ƒæ˜ å°„ä¸­
            if moki_number not in MOKI_TRAINING_MAP:
                print(f"  â­ï¸ Moki #{moki_number} ä¸åœ¨è®­ç»ƒåˆ—è¡¨ä¸­ï¼Œè·³è¿‡")
                click_element_by_text('Back to All Mokis', timeout=5, description="è¿”å›åˆ—è¡¨")
                time.sleep(3)
                return False
            
            # â­ ç‚¹å‡» Results æˆ– Trainï¼Œå¹¶è®°å½•ç‚¹å‡»äº†å“ªä¸ª
            is_from_train = False
            if not click_element_by_text('Results', timeout=30, description="Results"):
                if click_element_by_text('Train', timeout=3, description="Train"):
                    is_from_train = True  # æ ‡è®°æ˜¯ä»Trainè¿›å…¥çš„
                    time.sleep(1.5)
            else:
                time.sleep(1.5)
            
            # â­ å®Œæˆè®­ç»ƒæµç¨‹ï¼Œä¼ å…¥æ ‡è®°
            return complete_training_flow(moki_number, is_from_train)
        else:
            print("  âŒ æœªæ£€æµ‹åˆ° COMPLETE æˆ– Restingï¼Œè·³è¿‡")
            return False

    except Exception as e:
        print(f"  å‡ºé”™: {e}")
        return False


def scan_and_process_cards():
    """æ‰«æå¹¶å¤„ç†æ‰€æœ‰å¡ç‰‡"""
    processed_count = 0
    
    while True:
        try:
            # â­ è°ƒè¯•ï¼šå…ˆæ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
            print("\nğŸ” å¼€å§‹æŸ¥æ‰¾å®¹å™¨...")
            container = tab.ele('xpath=/html/body/div[3]/div[2]/main/div/div[2]', timeout=2)
            
            if not container:
                print("âŒ æ‰¾ä¸åˆ°æŒ‡å®šçš„å¡ç‰‡å®¹å™¨ï¼")
                print("ğŸ” å°è¯•å…¶ä»–é€‰æ‹©å™¨...")
                
                # å°è¯•å…¶ä»–å¯èƒ½çš„é€‰æ‹©å™¨
                container = tab.ele('css:main div', timeout=2)
                if container:
                    print("âœ… ä½¿ç”¨å¤‡é€‰å®¹å™¨")
                else:
                    print("âŒ æ‰€æœ‰å®¹å™¨éƒ½æ‰¾ä¸åˆ°")
                    break
            else:
                print("âœ… æ‰¾åˆ°å®¹å™¨")
            
            # â­ è°ƒè¯•ï¼šæ˜¾ç¤ºå®¹å™¨HTML
            print(f"ğŸ“„ å®¹å™¨HTMLé¢„è§ˆ: {container.html[:200]}...")
            
            # â­ å°è¯•å¤šç§å¡ç‰‡é€‰æ‹©å™¨
            print("\nğŸ” å°è¯•æŸ¥æ‰¾å¡ç‰‡...")
            
            # æ–¹æ³•1: åŸé€‰æ‹©å™¨
            cards = container.eles('css:a[href*="/mymokis/"]', timeout=2)
            print(f"   æ–¹æ³•1 (hrefåŒ…å«/mymokis/): æ‰¾åˆ° {len(cards)} ä¸ª")
            
            # if len(cards) == 0:
            #     # æ–¹æ³•2: æŸ¥æ‰¾æ‰€æœ‰é“¾æ¥
            #     cards = container.eles('tag:a', timeout=2)
            #     print(f"   æ–¹æ³•2 (æ‰€æœ‰aæ ‡ç­¾): æ‰¾åˆ° {len(cards)} ä¸ª")
                
            #     # æ‰“å°å‰3ä¸ªé“¾æ¥çš„href
            #     for i, card in enumerate(cards[:3]):
            #         href = card.attr('href') or 'æ— href'
            #         print(f"      å¡ç‰‡{i}: {href}")
            
            if len(cards) == 0:
                # æ–¹æ³•3: æŸ¥æ‰¾canvasçš„çˆ¶å…ƒç´ 
                canvases = tab.eles('tag:canvas', timeout=2)
                print(f"   æ–¹æ³•3 (æŸ¥æ‰¾canvas): æ‰¾åˆ° {len(canvases)} ä¸ª")
                
                if len(canvases) > 0:
                    # æ‰¾åˆ°canvasï¼Œè·å–å®ƒä»¬çš„çˆ¶å¡ç‰‡
                    cards = []
                    for canvas in canvases:
                        # å‘ä¸ŠæŸ¥æ‰¾åŒ…å«canvasçš„å¡ç‰‡å®¹å™¨
                        parent = canvas.parent(6)  # å°è¯•å¾€ä¸Šæ‰¾6å±‚
                        if parent:
                            cards.append(parent)
                    print(f"   ä»canvasè·å–åˆ° {len(cards)} ä¸ªå¡ç‰‡")
            
            if len(cards) == 0:
                print("\nâŒ æ— æ³•æ‰¾åˆ°ä»»ä½•å¡ç‰‡")
                break
            
            print(f"\nğŸ“¦ æœ€ç»ˆæ‰¾åˆ° {len(cards)} ä¸ªå¡ç‰‡")
            
            # æ ‡è®°æ˜¯å¦å¤„ç†äº†ä»»ä½•å¡ç‰‡
            found_any = False
            
            for i, card in enumerate(cards):
                if process_single_card(i, card):
                    processed_count += 1
                    found_any = True
                    print("  â³ å¡ç‰‡å¤„ç†å®Œæˆï¼Œé‡æ–°æ‰«æåˆ—è¡¨...")
                    time.sleep(3)
                    break
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯å¤„ç†çš„å¡ç‰‡ï¼Œé€€å‡ºå¾ªç¯
            if not found_any:
                print("  âœ… æ‰€æœ‰å¡ç‰‡å·²æ‰«æå®Œæ¯•")
                break
                
        except Exception as e:
            print(f"âŒ æ‰«æå¡ç‰‡å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            break
    
    return processed_count


def main_loop():
    """ä¸»å¾ªç¯ï¼šæŒç»­ç›‘æ§å’Œè®­ç»ƒ"""
    print("ğŸš€ å¼€å§‹å¾ªç¯ç›‘æ§è®­ç»ƒä»»åŠ¡...")
    print("=" * 50)
    print("ğŸ“‹ å½“å‰è®­ç»ƒé…ç½®:")
    for moki_id, attr in MOKI_TRAINING_MAP.items():
        quick_status = MOKI_QUICK_COUNT.get(moki_id, 0)
        print(f"   Moki #{moki_id} -> {attr} (Quickè®¡æ•°: {quick_status}/2)")
    print("=" * 50)
    
    loop_count = 0
    total_processed = 0
    
    while True:
        try:
            loop_count += 1
            print(f"\n{'='*50}")
            print(f"ğŸ” ç¬¬ {loop_count} è½®æ‰«æ")
            print(f"{'='*50}")
            
            processed = scan_and_process_cards()
            total_processed += processed
            
            if processed > 0:
                print(f"\nâœ… æœ¬è½®å¤„ç†äº† {processed} ä¸ªä»»åŠ¡")
                # æ˜¾ç¤ºå½“å‰æ¯ä¸ªMokiçš„Quickè®¡æ•°
                print("ğŸ“Š å½“å‰Quickè®¡æ•°çŠ¶æ€:")
                for moki_id in MOKI_TRAINING_MAP.keys():
                    count = MOKI_QUICK_COUNT.get(moki_id, 0)
                    print(f"   Moki #{moki_id}: {count}/2")
            else:
                print(f"\nğŸ’¤ æœ¬è½®æ²¡æœ‰å¯è®­ç»ƒçš„Mokiï¼Œç­‰å¾…30ç§’åé‡æ–°æ‰«æ...")
                time.sleep(30)
            
            print(f"ğŸ“Š æ€»è®¡å·²å¤„ç†: {total_processed} ä¸ªä»»åŠ¡")
            
            # çŸ­æš‚ç­‰å¾…åç»§ç»­ä¸‹ä¸€è½®
            time.sleep(5)
            
        except KeyboardInterrupt:
            print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­ç¨‹åº")
            print(f"ğŸ“Š æ€»è®¡å¤„ç†äº† {total_processed} ä¸ªè®­ç»ƒä»»åŠ¡")
            break
        except Exception as e:
            print(f"\nâŒ ä¸»å¾ªç¯å‡ºé”™: {e}")
            print("â³ ç­‰å¾…10ç§’åé‡è¯•...")
            time.sleep(10)


# è¿è¡Œä¸»å¾ªç¯
if __name__ == "__main__":
    main_loop()
